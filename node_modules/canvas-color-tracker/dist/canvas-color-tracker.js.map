{"version":3,"file":"canvas-color-tracker.js","sources":["../src/index.js"],"sourcesContent":["const ENTROPY = 123; // Raise numbers to prevent collisions in lower indexes\n\nconst int2HexColor = num => `#${Math.min(num, Math.pow(2, 24)).toString(16).padStart(6, '0')}`;\nconst rgb2Int = (r, g, b) => (r << 16) + (g << 8) + b;\n\nconst checksum = (n, csBits) => (n * ENTROPY) % Math.pow(2, csBits);\n\nexport default class {\n  constructor(csBits = 6) {\n    this.csBits = csBits; // How many bits to reserve for checksum. Will eat away into the usable size of the registry.\n    this.registry = ['__reserved for background__']; // indexed objects for rgb lookup;\n  }\n\n  register(obj) {\n    if (this.registry.length >= Math.pow(2, 24 - this.csBits)) { // color has 24 bits (-checksum)\n      return null; // Registry is full\n    }\n\n    const idx = this.registry.length;\n    const cs = checksum(idx, this.csBits);\n\n    const color = int2HexColor(idx + (cs << (24 - this.csBits)));\n\n    this.registry.push(obj);\n    return color;\n  }\n\n  lookup([r, g, b]) {\n    const n = rgb2Int(r, g, b);\n\n    if (!n) return null; // 0 index is reserved for background\n\n    const idx = n & (Math.pow(2, 24 - this.csBits) - 1); // registry index\n    const cs = (n >> (24 - this.csBits)) & (Math.pow(2, this.csBits) - 1); // extract bits reserved for checksum\n\n    if (checksum(idx, this.csBits) !== cs || idx >= this.registry.length) return null; // failed checksum or registry out of bounds\n\n    return this.registry[idx];\n  }\n}"],"names":["ENTROPY","int2HexColor","Math","min","num","pow","toString","padStart","rgb2Int","r","g","b","checksum","n","csBits","registry","obj","length","idx","cs","color","push"],"mappings":";;;;;;;;;;;;;EAAA,IAAMA,UAAU,GAAhB;;EAEA,IAAMC,eAAe,SAAfA,YAAe;EAAA,eAAWC,KAAKC,GAAL,CAASC,GAAT,EAAcF,KAAKG,GAAL,CAAS,CAAT,EAAY,EAAZ,CAAd,EAA+BC,QAA/B,CAAwC,EAAxC,EAA4CC,QAA5C,CAAqD,CAArD,EAAwD,GAAxD,CAAX;EAAA,CAArB;EACA,IAAMC,UAAU,SAAVA,OAAU,CAACC,CAAD,EAAIC,CAAJ,EAAOC,CAAP;EAAA,SAAa,CAACF,KAAK,EAAN,KAAaC,KAAK,CAAlB,IAAuBC,CAApC;EAAA,CAAhB;;EAEA,IAAMC,WAAW,SAAXA,QAAW,CAACC,CAAD,EAAIC,MAAJ;EAAA,SAAgBD,IAAIb,OAAL,GAAgBE,KAAKG,GAAL,CAAS,CAAT,EAAYS,MAAZ,CAA/B;EAAA,CAAjB;;;EAGE,oBAAwB;EAAA,QAAZA,MAAY,uEAAH,CAAG;;EAAA;;EACtB,SAAKA,MAAL,GAAcA,MAAd,CADsB;EAEtB,SAAKC,QAAL,GAAgB,CAAC,6BAAD,CAAhB,CAFsB;EAGvB;;;;+BAEQC,KAAK;EACZ,UAAI,KAAKD,QAAL,CAAcE,MAAd,IAAwBf,KAAKG,GAAL,CAAS,CAAT,EAAY,KAAK,KAAKS,MAAtB,CAA5B,EAA2D;EAAE;EAC3D,eAAO,IAAP,CADyD;EAE1D;;EAED,UAAMI,MAAM,KAAKH,QAAL,CAAcE,MAA1B;EACA,UAAME,KAAKP,SAASM,GAAT,EAAc,KAAKJ,MAAnB,CAAX;;EAEA,UAAMM,QAAQnB,aAAaiB,OAAOC,MAAO,KAAK,KAAKL,MAAxB,CAAb,CAAd;;EAEA,WAAKC,QAAL,CAAcM,IAAd,CAAmBL,GAAnB;EACA,aAAOI,KAAP;EACD;;;mCAEiB;EAAA;EAAA,UAAVX,CAAU;EAAA,UAAPC,CAAO;EAAA,UAAJC,CAAI;;EAChB,UAAME,IAAIL,QAAQC,CAAR,EAAWC,CAAX,EAAcC,CAAd,CAAV;;EAEA,UAAI,CAACE,CAAL,EAAQ,OAAO,IAAP,CAHQ;;EAKhB,UAAMK,MAAML,IAAKX,KAAKG,GAAL,CAAS,CAAT,EAAY,KAAK,KAAKS,MAAtB,IAAgC,CAAjD,CALgB;EAMhB,UAAMK,KAAMN,KAAM,KAAK,KAAKC,MAAjB,GAA6BZ,KAAKG,GAAL,CAAS,CAAT,EAAY,KAAKS,MAAjB,IAA2B,CAAnE,CANgB;;EAQhB,UAAIF,SAASM,GAAT,EAAc,KAAKJ,MAAnB,MAA+BK,EAA/B,IAAqCD,OAAO,KAAKH,QAAL,CAAcE,MAA9D,EAAsE,OAAO,IAAP,CARtD;;EAUhB,aAAO,KAAKF,QAAL,CAAcG,GAAd,CAAP;EACD;;;;;;;;;;;;"}